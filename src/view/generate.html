<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>GPT CoBuilder</title>
    <link rel="stylesheet" href="generate.css" />
  </head>
  <body>
    <div class="tab">
      <button class="tablinks" onclick="openTab(event, 'Settings')">Settings</button>
      <button id="changeRequestTab" class="tablinks" onclick="openTab(event, 'ChangeRequest')">Change Request</button>
      <button class="tablinks" onclick="openTab(event, 'ChangeResponse')">Change Response</button>
      <button class="tablinks" onclick="openTab(event, 'Convert')">Convert</button>
      <button class="tablinks" id="add-tab-button">+</button>
    </div>
    
    <!-- Tab content -->
    <div id="Settings" class="tabcontent">
      <!-- Input field for ChatGPT API key -->
      <label for="api-key">ChatGPT API Key:</label>
      <input type="text" id="api-key" />

      <!-- Input field for folder selection -->
      <label for="folder-selection">Select a Folder:</label>
      <button id="folder-selection">Project folder</button>
      <!-- Display Selected Folder -->
      <span id="folder-display"></span>
      
      <!-- Textarea for project description -->
      <label for="project-description">Project Description:</label>
      <textarea id="project-description" rows="5">This is an electron project that aims to let users quickly create and iterate on applications.</textarea>
    </div>

    <div id="ChangeRequest" class="tabcontent">
        <!-- Element to display the file structure -->
        <pre id="file-structure"></pre>
        
      <!-- Input field for system message -->
      <label for="system-message">System Message:</label>
      <textarea id="system-message" rows="5" >You are a good programmer and you should do your best to suggest complete code changes to achieve the users goal. 

Suggest changes to the right files. If you need to change multiple files, include which code belongs in which file. At the end, include a git commit message for this change in the format:

Git commit message: The commit message describing the changes</textarea>

      <!-- Div for generated message -->
      <div id="generated-message-div">
        <label for="generated-message">Generated Message:</label>
        <textarea id="generated-message" class="generated-message" rows="20" disabled></textarea>
      </div>

      <!-- Input field for user message -->
      <label for="user-message">User Message:</label>
      <textarea id="user-message" rows="5" ></textarea>

      <!-- Div for full message -->
      <div>
        <label for="full-message">Full Message:</label>
        <textarea id="full-message" class="full-message" rows="20" disabled></textarea>
      </div>
          
      <!-- Total tokens count -->
      <div id="local-token-count"></div>

      <!-- Button to trigger GPT completion -->
      <button class="button" id="generate-button">Generate GPT Completion</button>

      <!-- Element to display errors -->
      <div id="error-log"></div>
    </div>
    
    <div id="ChangeResponse" class="tabcontent">
      <!-- Total tokens count -->
      <div id="response-token-count"></div>

      <!-- Model response -->
      <label for="model-response">Model response:</label>
      <textarea id="model-response"></textarea>
    </div>

    <div id="Convert" class="tabcontent">
      <!-- Input field for user message -->
      <label for="convert-system-message">Convert System Message:</label>
      <textarea id="convert-system-message" rows="5" ></textarea>

      <!-- Input field for user message -->
      <label for="convert-user-message">Optional Convert User Message:</label>
      <textarea id="convert-user-message" rows="5" ></textarea>

      <!-- Button to convert change request to files -->
      <button class="button" id="convert-button" disabled>Convert change request to files</button>

      <!-- Model files response -->
      <label for="model-files-response">Model response:</label>
      <textarea id="model-files-response"></textarea>

      <!-- Total tokens count -->
      <div id="files-response-token-count"></div>

      <!-- Button to apply files automatically -->
      <button class="button" id="apply-button">Apply files</button>
    </div>
    
    <!-- Add Modal for tab naming -->
    <div id="tabNameModal" class="modal">
        <div class="modal-content">
            <label for="tabNameInput">Name of the tab:</label>
            <input type="text" id="tabNameInput" />
            <button id="submitTabNameButton">Submit</button>
        </div>
    </div>

    <script src="generate.js"></script>
    <script>
      function openTab(evt, tabName) {
        // Declare all variables
        var i, tabcontent, tablinks;

        // Get all elements with class="tabcontent" and hide them
        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
          tabcontent[i].style.display = "none";
        }

        // Get all elements with class="tablinks" and remove the class "active"
        tablinks = document.getElementsByClassName("tablinks");
        for (i = 0; i < tablinks.length; i++) {
          tablinks[i].className = tablinks[i].className.replace(" active", "");
        }

        // Show the current tab, and add an "active" class to the button that opened the tab
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
      }

      document.getElementById("changeRequestTab").click();
    </script>
    <script>
      // Attach event listener to the button
      const generateButton = document.getElementById('generate-button');
      const convertButton = document.getElementById('convert-button');
      const errorLog = document.getElementById('error-log');
      const reponseField = document.getElementById('model-response');

      function clearErrorLog() {
        errorLog.textContent = "";
      }

      const userMessage = 'Hello, how can you help me?';
      generateButton.addEventListener('click', () => {
        openTab(event, 'ChangeResponse');
        
        reponseField.disabled = true;
        generateButton.disabled = true;
        convertButton.disabled = true;
        
        sendMessageToChatGPT()
        .then(response => {
          console.log('Assistant:', response);
          reponseField.disabled = false;
          generateButton.disabled = false;
          convertButton.disabled = false;

          clearErrorLog();
          displayAssistantResponse(response);
        })
        .catch(error => {
          errorLog.textContent = `Error: ${error.message}`;
          reponseField.disabled = false;
          generateButton.disabled = false;
          convertButton.disabled = false;
        });
      });

      convertButton.addEventListener('click', () => {
        convertButton.disabled = true;
        convertChangeRequestToFiles();
      });
    </script>
    <script>
      const addTabButton = document.getElementById("add-tab-button");
      const tabNameModal = document.getElementById("tabNameModal");
      const submitTabNameButton = document.getElementById("submitTabNameButton");
      const tabNameInput = document.getElementById("tabNameInput");
      const tabs = document.querySelector(".tab");

      addTabButton.addEventListener('click', () => {
          tabNameModal.style.display = "block";
      });

      submitTabNameButton.addEventListener('click', () => {
          // Get the tab name from the input
          const tabName = tabNameInput.value;
          const newTabButton = document.createElement("button");

          newTabButton.className = "tablinks";
          newTabButton.innerText = tabName;
          newTabButton.onclick = (event) => openTab(event, tabName);

          // Insert new tab next to add tab button
          tabs.insertBefore(newTabButton, addTabButton);

          // Reset the input value
          tabNameInput.value = "";
          tabNameModal.style.display = "none";
          
          // Create a new Div for the new tab
          const newDiv = document.createElement("div");
          newDiv.id = tabName;
          newDiv.className = "tabcontent";
          document.body.appendChild(newDiv); // add new div to the body
      }); 

      window.addEventListener('click', (event) => {
          if (event.target == tabNameModal) {
              tabNameModal.style.display = "none";
          }
      });
    </script>
  </body>
</html>
